# Project Context

## Purpose
é¾è± SSO å®¢æˆ¶ç«¯æ¨¡çµ„ï¼ˆLungFung SSOï¼‰ï¼Œæä¾›å…¨é¢çš„å–®é»ç™»éŒ„ï¼ˆSingle Sign-Onï¼‰è§£æ±ºæ–¹æ¡ˆï¼Œå¯è¼•é¬†é›†æˆåˆ°ä»»ä½• Django å­ç³»çµ±ä¸­ï¼Œå¯¦ç¾çµ±ä¸€çš„èº«ä»½èªè­‰èˆ‡æ¬Šé™ç®¡ç†ã€‚

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ğŸ” **JWT ä»¤ç‰Œèªè­‰** - ä»¤ç‰Œè‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶ã€å®‰å…¨çš„ Cookie ç®¡ç†ã€èªè­‰ä¸­é–“ä»¶è‡ªå‹•é©—è­‰
- ğŸ›¡ï¸ **ç²¾ç´°çš„æ¬Šé™æ§åˆ¶** - æ¨¡çµ„åŒ–æ¬Šé™æ¶æ§‹ã€åŸºæ–¼æ¨¡çµ„èˆ‡æ“ä½œçš„ç´°ç²’åº¦æ§åˆ¶ã€æ¬Šé™è£é£¾å™¨èˆ‡æ¬Šé™é¡
- ğŸ”„ **é«˜æ•ˆçš„ç·©å­˜æ©Ÿåˆ¶** - ä»¤ç‰Œé©—è­‰çµæœç·©å­˜ã€ç”¨æˆ¶ä¿¡æ¯èˆ‡æ¬Šé™æ•¸æ“šç·©å­˜ã€å¯é…ç½®çš„ç·©å­˜ç­–ç•¥
- ğŸ” **å¥åº·ç›£æ§** - é›†æˆçš„å¥åº·æª¢æŸ¥ APIã€å„é …æœå‹™ç‹€æ…‹ç›£æ§
- âš™ï¸ **é«˜åº¦å¯é…ç½®** - è±å¯Œçš„ç’°å¢ƒè®Šé‡æ”¯æŒã€éˆæ´»çš„è¨­ç½®é …

## Tech Stack
- **Python** >= 3.11
- **Django** >= 5.0.0
- **Django REST Framework** >= 3.15.0
- **requests** >= 2.31.0
- **PyJWT** >= 2.8.0
- **python-dotenv** >= 1.0.0

**é–‹ç™¼ä¾è³´ï¼š**
- pytest >= 7.0.0
- pytest-django >= 4.5.0
- black >= 23.0.0
- flake8 >= 6.0.0
- isort >= 5.12.0

**æ§‹å»ºå·¥å…·ï¼š**
- hatchling (build-backend)

## Project Conventions

### Code Style
- ä½¿ç”¨ **Black** é€²è¡Œä»£ç¢¼æ ¼å¼åŒ–ï¼Œè¡Œé•·åº¦é™åˆ¶ç‚º 88 å­—ç¬¦
- ä½¿ç”¨ **isort** é€²è¡Œå°å…¥æ’åºï¼Œé…ç½®ç‚º Black å…¼å®¹æ¨¡å¼
- ä½¿ç”¨ **flake8** é€²è¡Œä»£ç¢¼æª¢æŸ¥
- ç›®æ¨™ Python ç‰ˆæœ¬ï¼š3.11
- è®Šé‡å’Œå‡½æ•¸å‘½åä½¿ç”¨ snake_case
- é¡å‘½åä½¿ç”¨ PascalCase
- å¸¸é‡ä½¿ç”¨ UPPER_SNAKE_CASE

### Architecture Patterns
**åŒ…çµæ§‹ï¼š**
```
src/lungfung_sso/
â”œâ”€â”€ __init__.py          # ä¸»å…¥å£ï¼Œå»¶é²å°å…¥æ¨¡å¼
â”œâ”€â”€ apps.py              # Django App é…ç½®
â”œâ”€â”€ authentication.py    # SSO èªè­‰æœå‹™
â”œâ”€â”€ cache.py             # ç·©å­˜åŠŸèƒ½
â”œâ”€â”€ exceptions.py        # è‡ªå®šç¾©ç•°å¸¸
â”œâ”€â”€ middleware.py        # JWT èªè­‰ä¸­é–“ä»¶
â”œâ”€â”€ models.py            # ç”¨æˆ¶æ¨¡å‹
â”œâ”€â”€ permissions.py       # æ¬Šé™æ§åˆ¶
â”œâ”€â”€ settings_helper.py   # è¨­ç½®åŠ©æ‰‹å‡½æ•¸
â””â”€â”€ utils.py             # å·¥å…·å‡½æ•¸
```

**è¨­è¨ˆæ¨¡å¼ï¼š**
- **å»¶é²å°å…¥æ¨¡å¼** - ä½¿ç”¨ `__getattr__` å¯¦ç¾å»¶é²å°å…¥ï¼Œåªæœ‰åœ¨å¯¦éš›ä½¿ç”¨æ™‚æ‰å°å…¥ Django ä¾è³´çµ„ä»¶
- **Mixin æ¨¡å¼** - `ModulePermissionRequiredMixin` æä¾›æ¬Šé™æª¢æŸ¥åŠŸèƒ½
- **è£é£¾å™¨æ¨¡å¼** - `@module_permission_required` ç”¨æ–¼å‡½æ•¸è¦–åœ–çš„æ¬Šé™æª¢æŸ¥
- **ç­–ç•¥æ¨¡å¼** - å¯é…ç½®çš„ç·©å­˜ç­–ç•¥å’Œæ¬Šé™æª¢æŸ¥ç­–ç•¥

**API è¨­è¨ˆï¼š**
- æä¾›ä¾¿æ·çš„è¨­ç½®åŠ©æ‰‹å‡½æ•¸ï¼š`configure_sso_settings()`, `add_sso_middleware()`, `add_sso_app()`
- æ”¯æŒå¤šç¨®æ¬Šé™æª¢æŸ¥æ–¹å¼ï¼šMixinã€è£é£¾å™¨ã€ç›´æ¥èª¿ç”¨ `check_permission()`

### Testing Strategy
- ä½¿ç”¨ **pytest** å’Œ **pytest-django** é€²è¡Œå–®å…ƒæ¸¬è©¦
- æ¸¬è©¦æ–‡ä»¶ä½æ–¼ `tests/` ç›®éŒ„
- æ¸¬è©¦ JWT èªè­‰ã€æ¬Šé™æª¢æŸ¥ã€SSO æœå‹™èª¿ç”¨ç­‰æ ¸å¿ƒåŠŸèƒ½

### Git Workflow
- ä¸»åˆ†æ”¯ï¼š`main`
- ç‰ˆæœ¬è™Ÿéµå¾ªèªç¾©åŒ–ç‰ˆæœ¬æ§åˆ¶ (SemVer)
- ç•¶å‰ç‰ˆæœ¬ï¼š1.0.3

## Domain Context
**æ”¯æŒçš„å­ç³»çµ±ï¼š**
- **TAICHENG** (å¤§æ­£ç³»çµ±) - è½‰è²¨å–®ã€éŠ·å”®/æ¡è³¼ç™¼ç¥¨ã€åº«å­˜ç®¡ç†
- **STS** (åº«å­˜ç³»çµ±) - åº«å­˜ç®¡ç†ã€å€Ÿå‡ºç®¡ç†ã€ä»˜æ¬¾è™•ç†ã€ç›¤é»ç®¡ç†

**æ¬Šé™æ¨¡å‹ï¼š**
```
ç³»çµ±ç´šæ¬Šé™
â”œâ”€â”€ manage_system_name_system (å®Œæ•´ç®¡ç†æ¬Šé™)
â”œâ”€â”€ view_system_name_system (ç³»çµ±æŸ¥çœ‹æ¬Šé™)
â””â”€â”€ æ¨¡çµ„ç´šæ¬Šé™
    â”œâ”€â”€ module.view_module
    â”œâ”€â”€ module.add_module
    â”œâ”€â”€ module.change_module
    â”œâ”€â”€ module.delete_module
    â””â”€â”€ module.special_action_module (ç‰¹æ®Šæ¬Šé™å¦‚ approve, sync, export)
```

**æ¬Šé™ç¹¼æ‰¿æ©Ÿåˆ¶ï¼š**
| ç³»çµ±ç´šæ¬Šé™ | è‡ªå‹•ç²å¾—çš„æ¨¡çµ„æ¬Šé™ |
|-----------|-------------------|
| `manage_system_name_system` | è‡ªå‹•ç²å¾—æ‰€æœ‰å­æ¨¡çµ„çš„**å…¨éƒ¨æ¬Šé™**ï¼ˆview, add, change, delete ç­‰ï¼‰ |
| `view_system_name_system` | è‡ªå‹•ç²å¾—æ‰€æœ‰å­æ¨¡çµ„çš„**æŸ¥çœ‹æ¬Šé™**ï¼ˆviewï¼‰ |
| è¶…ç´šç”¨æˆ¶ (`is_superuser=True`) | è·³éæ‰€æœ‰æ¬Šé™æª¢æŸ¥ï¼Œç›´æ¥å…è¨±è¨ªå• |

## Important Constraints
- **ç§æœ‰é …ç›®** - ç‰ˆæ¬Šæ‰€æœ‰ Â© 2025 é¾è±è—¥æ¥­é›†åœ˜æœ‰é™å…¬å¸ï¼Œåƒ…ä¾›å…§éƒ¨ä½¿ç”¨
- **Python ç‰ˆæœ¬** - æœ€ä½è¦æ±‚ Python 3.11
- **Django ç‰ˆæœ¬** - æœ€ä½è¦æ±‚ Django 5.0
- **SSL é…ç½®** - é–‹ç™¼ç’°å¢ƒå¯è¨­ç½® `VERIFY_SSL=false`ï¼Œç”Ÿç”¢ç’°å¢ƒå¿…é ˆè¨­ç‚º `true`
- **ç·©å­˜ä¾è³´** - éœ€è¦é…ç½® Django ç·©å­˜å¾Œç«¯ä»¥å•Ÿç”¨ç·©å­˜åŠŸèƒ½

## External Dependencies
**SSO æœå‹™ï¼š**
- SSO æœå‹™å™¨ URL (é è¨­: `http://sso.lungfung.hk`)
- èªè­‰ç«¯é»ï¼š`/api/auth/token/`, `/api/auth/verify/`, `/api/auth/token/refresh/`
- ç”¨æˆ¶ä¿¡æ¯ç«¯é»ï¼š`/api/auth/user/info/`, `/api/auth/user/profile/`
- æ¬Šé™ç«¯é»ï¼š`/api/core/permissions/user/`, `/api/core/permissions/check/`
- æ¨¡çµ„ç«¯é»ï¼š`/api/core/modules/`, `/api/core/modules/check/`
- å¥åº·æª¢æŸ¥ç«¯é»ï¼š`/api/health/`

**ç’°å¢ƒè®Šé‡ï¼š**
- `SSO_SERVICE_URL` - SSO æœå‹™åŸºç¤ URL
- `SSO_VERIFY_SSL` - æ˜¯å¦é©—è­‰ SSL è­‰æ›¸
- `SSO_REQUEST_TIMEOUT` - è«‹æ±‚è¶…æ™‚æ™‚é–“ï¼ˆç§’ï¼‰
- `CACHE_KEY_PREFIX` - ç·©å­˜éµå‰ç¶´
- `TOKEN_VERIFICATION_CACHE_TTL` - ä»¤ç‰Œé©—è­‰ç·©å­˜æ™‚é–“
- `USER_CACHE_TIMEOUT` - ç”¨æˆ¶ç·©å­˜è¶…æ™‚æ™‚é–“
